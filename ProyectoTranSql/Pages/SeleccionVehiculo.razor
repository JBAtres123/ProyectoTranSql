@page "/VehiculosList"
@using Microsoft.EntityFrameworkCore
@using ProyectoTranSql.Models
@inject ProyectoTranSql.Data.MyDbContext DbContext
@inject NavigationManager NavigationManager

<head>
    <link href="css/StyleVehiculosList.css" rel="stylesheet" />
</head>

<h3>Lista de Vehículos Disponibles</h3>

@if (vehiculos != null && vehiculos.Any())
{
    <table class="vehiculos-table">
        <thead>
            <tr>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Año</th>
                <th>Placa</th>
                <th>Tipo de Vehículo</th>
                <th>Capacidad</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var vehiculo in vehiculos)
            {
                <tr>
                    <td>@vehiculo.ModeloVehiculo.MarcaVehiculo.Marca</td>
                    <td>@vehiculo.ModeloVehiculo.Modelo</td>
                    <td>@vehiculo.ModeloVehiculo.Año</td>
                    <td>@vehiculo.Placa</td>
                    <td>@vehiculo.TipoVehiculo.Tipo</td>
                    <td>@vehiculo.Capacidad</td>
                    <td>
                        <span class="estado-vehiculo @(GetEstadoCssClass(vehiculo.EstadoVehiculoID))">
                            @vehiculo.EstadoVehiculo.Estado
                        </span>
                    </td>
                    <td>
                        @if (vehiculo.EstadoVehiculoID == 1)
                        {
                            <button @onclick="() => AsignarVehiculo(vehiculo)">Asignar</button>
                        }
                        <select @onchange="(e) => CambiarEstadoVehiculo(vehiculo, e)">
                            <option value="">Cambiar Estado</option>
                            <option value="1">Estado 1 (Disponible)</option>
                            <option value="2">Estado 2 (Reservado)</option>
                            <option value="3">Estado 3 (En Ruta)</option>
                            <option value="4">Estado 4 (Inactivo)</option>
                        </select>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No hay vehículos disponibles en la base de datos.</p>
}

@code {
    private List<Vehiculo> vehiculos;

    protected override async Task OnInitializedAsync()
    {
        vehiculos = await DbContext.Vehiculos
            .Include(v => v.ModeloVehiculo)
            .Include(v => v.ModeloVehiculo.MarcaVehiculo)
            .Include(v => v.EstadoVehiculo)
            .Include(v => v.TipoVehiculo)
            .Where(v => v.EstadoVehiculoID == 1 || v.EstadoVehiculoID == 2 || v.EstadoVehiculoID == 3 || v.EstadoVehiculoID == 4)
            .ToListAsync();
    }

    private async Task AsignarVehiculo(Vehiculo vehiculo)
    {
        vehiculo.EstadoVehiculoID = 2;

        DbContext.Vehiculos.Update(vehiculo);
        await DbContext.SaveChangesAsync();

        NavigationManager.NavigateTo($"/DetallesVehiculo/{vehiculo.VehiculoID}");
    }

    private async Task CambiarEstadoVehiculo(Vehiculo vehiculo, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var nuevoEstadoID))
        {
            // Actualizar el estado del vehículo en la base de datos
            vehiculo.EstadoVehiculoID = nuevoEstadoID;

            // Guardar cambios en la base de datos
            DbContext.Vehiculos.Update(vehiculo);
            await DbContext.SaveChangesAsync();

            // Actualizar el objeto EstadoVehiculo en el vehiculo directamente desde la base de datos
            vehiculo.EstadoVehiculo = await DbContext.EstadosVehiculo.FindAsync(nuevoEstadoID);

            // Aquí forzamos una actualización en la vista
            StateHasChanged();
        }
    }

    private string GetEstadoCssClass(int estadoId)
    {
        return estadoId switch
        {
            1 => "estado-verde",  // Disponible
            2 => "estado-gris",   // Reservado
            3 => "estado-azul-claro", // En Ruta
            4 => "estado-rojo",   // Inactivo
            _ => ""
        };
    }
}
